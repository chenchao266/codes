/*------------------------------------------------------------------------------

   HXA7241 Graphics library.
   Copyright (c) 2004-2006,  Harrison Ainsworth / HXA7241.

   http://www.hxa7241.org/

------------------------------------------------------------------------------*/


#include "SobolSequence.hpp"


using namespace hxa7241_graphics;




/// constants
// (~ 4.7Kb. overall exe came out ~2K smaller using these precalcs instead of code)
const dword SobolSequence::V_DIRECTION[SOBOL_BIT_COUNT][SOBOL_MAX_DIMENSION] =
{
   { 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912, 536870912 },
   { 268435456, 805306368, 268435456, 805306368, 268435456, 805306368, 268435456, 805306368, 805306368, 268435456, 805306368, 268435456, 805306368, 268435456, 805306368, 268435456, 268435456, 805306368, 268435456, 805306368, 268435456, 805306368, 268435456, 805306368, 805306368, 268435456, 805306368, 268435456, 805306368, 268435456, 805306368, 268435456, 268435456, 805306368, 268435456, 805306368, 268435456, 805306368, 268435456, 805306368 },
   { 134217728, 671088640, 939524096, 939524096, 671088640, 134217728, 402653184, 402653184, 939524096, 671088640, 671088640, 939524096, 939524096, 134217728, 402653184, 402653184, 939524096, 671088640, 134217728, 134217728, 671088640, 402653184, 402653184, 134217728, 939524096, 671088640, 134217728, 402653184, 402653184, 939524096, 671088640, 134217728, 134217728, 671088640, 939524096, 939524096, 671088640, 134217728, 402653184, 402653184 },
   { 67108864, 1006632960, 738197504, 335544320, 201326592, 67108864, 469762048, 603979776, 872415232, 738197504, 67108864, 201326592, 469762048, 603979776, 335544320, 872415232, 872415232, 738197504, 201326592, 1006632960, 335544320, 201326592, 1006632960, 469762048, 603979776, 872415232, 603979776, 67108864, 738197504, 469762048, 335544320, 1006632960, 67108864, 1006632960, 738197504, 335544320, 201326592, 67108864, 469762048, 603979776 },
   { 33554432, 570425344, 436207616, 234881024, 503316480, 301989888, 1040187392, 301989888, 100663296, 905969664, 503316480, 973078528, 704643072, 771751936, 637534208, 369098752, 838860800, 234881024, 436207616, 570425344, 33554432, 838860800, 973078528, 100663296, 1040187392, 369098752, 167772160, 771751936, 905969664, 637534208, 704643072, 167772160, 33554432, 570425344, 436207616, 234881024, 503316480, 301989888, 1040187392, 301989888 },
   { 16777216, 855638016, 1023410176, 721420288, 855638016, 989855744, 788529152, 956301312, 587202560, 889192448, 318767104, 855638016, 1023410176, 620756992, 553648128, 117440512, 83886080, 184549376, 654311424, 1056964608, 452984832, 285212672, 251658240, 385875968, 486539264, 50331648, 352321536, 218103808, 520093696, 419430400, 150994944, 822083584, 553648128, 318767104, 486539264, 184549376, 318767104, 452984832, 251658240, 419430400 },
   { 8388608, 713031680, 562036736, 411041792, 1048576000, 209715200, 914358272, 360710144, 746586112, 578813952, 947912704, 394264576, 461373440, 813694976, 25165824, 310378496, 696254464, 864026624, 226492416, 109051904, 276824064, 964689920, 343932928, 662700032, 142606336, 243269632, 998244352, 629145600, 612368384, 880803840, 58720256, 494927872, 545259520, 176160768, 25165824, 947912704, 511705088, 746586112, 377487360, 897581056 },
   { 4194304, 1069547520, 331350016, 616562688, 591396864, 373293056, 725614592, 180355072, 37748736, 104857600, 482344960, 406847488, 79691776, 406847488, 826277888, 423624704, 1069547520, 121634816, 851443712, 272629760, 817889280, 742391808, 440401920, 71303168, 197132288, 708837376, 457179136, 624951296, 62914560, 893386752, 566231040, 1061158912, 801112064, 650117120, 734003200, 264241152, 197132288, 29360128, 96468992, 163577856 },
   { 2097152, 538968064, 975175680, 920649728, 371195904, 673185792, 379584512, 471859200, 492830720, 216006656, 861929472, 488636416, 123731968, 740294656, 689963008, 970981376, 807403520, 232783872, 996147200, 945815552, 551550976, 39845888, 522190848, 576716800, 773849088, 824180736, 350224384, 698351616, 991952896, 983564288, 211812352, 44040192, 945815552, 480247808, 517996544, 622854144, 845152256, 1042284544, 127926272, 757071872 },
   { 1048576, 808452096, 756023296, 1062207488, 795869184, 875560960, 995098624, 118489088, 974127104, 644874240, 164626432, 40894464, 797966336, 177209344, 1030750208, 688914432, 678428672, 609222656, 529530880, 873463808, 145752064, 154140672, 212860928, 84934656, 353370112, 869269504, 1037041664, 393216000, 382730240, 137363456, 225443840, 768606208, 472907776, 468713472, 185597952, 59768832, 493879296, 1026555904, 206569472, 263192576 },
   { 524288, 673710080, 431489024, 381157376, 139984896, 436731904, 246939648, 839385088, 703070208, 478674944, 904396800, 1059586048, 998768640, 196608000, 468189184, 838336512, 217579520, 317194240, 429391872, 511180800, 479723520, 899153920, 641204224, 716701696, 347602944, 329777152, 275251200, 245891072, 514326528, 873988096, 832045056, 655884288, 236453888, 252182528, 378011648, 253231104, 633864192, 763887616, 217579520, 752353280 },
   { 262144, 1010565120, 1072431104, 258736128, 482082816, 1057226752, 659292160, 151781376, 1012662272, 256114688, 907804672, 762576896, 885784576, 353632256, 980156416, 90963968, 101449728, 755236864, 739508224, 490995712, 513540096, 505675776, 626262016, 852230144, 301203456, 63700992, 946077696, 296484864, 445906944, 37486592, 351010816, 916717568, 655097856, 411828224, 257687552, 1054081024, 425984000, 843317248, 304873472, 780402688 },
   { 131072, 572653568, 540672000, 771883008, 908197888, 512884736, 814088192, 226885632, 176553984, 812253184, 369229824, 715522048, 1064173568, 671219712, 1005191168, 325189632, 930742272, 350879744, 184156160, 972947456, 95027200, 323092480, 61734912, 378404864, 224788480, 733347840, 745668608, 57802752, 415367168, 587857920, 827195392, 466223104, 63307776, 495583232, 418775040, 683278336, 666501120, 24248320, 959840256, 224526336 },
   { 65536, 858980352, 271384576, 453181440, 1064370176, 763035648, 140705792, 784924672, 289472512, 960167936, 655163392, 171376640, 865533952, 872480768, 175046656, 340852736, 751632384, 973537280, 797245440, 382533632, 353042432, 818085888, 848363520, 83820544, 12255232, 533004288, 774569984, 948371456, 499056640, 195362816, 267452416, 473366528, 776142848, 707723264, 607977472, 133103616, 1007353856, 432734208, 495648768, 761331712 },
   { 32768, 715816960, 941195264, 545488896, 542801920, 615284736, 103841792, 237273088, 166690816, 82149376, 244154368, 436764672, 293765120, 637566976, 602636288, 102334464, 383352832, 23625728, 23232512, 671121408, 631930880, 427851776, 1059094528, 159416320, 402554880, 161513472, 520650752, 413696000, 275415040, 412647424, 938377216, 439910400, 926842880, 520781824, 504791040, 153255936, 638746624, 36995072, 829718528, 490831872 },
   { 16384, 1073725440, 742375424, 817971200, 280805376, 577126400, 587743232, 1042169856, 206946304, 444153856, 197509120, 587972608, 163790848, 16924672, 510541824, 528433152, 259932160, 440778752, 680640512, 201375744, 84623360, 474005504, 481312768, 1061208064, 878690304, 177225728, 787791872, 145506304, 673955840, 997998592, 998359040, 959725568, 197083136, 15712256, 321732608, 435929088, 924794880, 591249408, 861192192, 89374720 },
   { 8192, 536879104, 438312960, 954261504, 673439744, 838868992, 277225472, 663576576, 847421440, 42639360, 367632384, 797270016, 619241472, 511893504, 99213312, 639328256, 402825216, 822632448, 471408640, 704651264, 229253120, 442523648, 1043881984, 199237632, 908091392, 67674112, 553263104, 284319744, 875094016, 128638976, 771104768, 569516032, 704684032, 162144256, 715022336, 171466752, 216014848, 547364864, 309207040, 559423488 },
   { 4096, 805318656, 1024462848, 340963328, 208809984, 184561664, 409145344, 63877120, 625233920, 374247424, 101969920, 340381696, 928395264, 1027756032, 1064062976, 259878912, 604114944, 844460032, 316059648, 50393088, 285937664, 87044096, 424996864, 173043712, 17846272, 777834496, 262115328, 348590080, 441741312, 110456832, 447582208, 889450496, 889212928, 874459136, 762441728, 222597120, 112226304, 401616896, 334958592, 860106752 },
   { 2048, 671098880, 565721088, 238651392, 517564416, 75499520, 506501120, 295766016, 266500096, 618969088, 1040906240, 657205248, 383997952, 480446464, 74053632, 1041934336, 167917568, 495147008, 731609088, 612403200, 262809600, 127453184, 967763968, 693639168, 314054656, 524179456, 689088512, 982005760, 694335488, 1040193536, 974686208, 868919296, 713041920, 774023168, 703072256, 530765824, 1068029952, 925370368, 481990656, 708974592 },
   { 1024, 1006648320, 334244864, 732843008, 872346624, 306185216, 1057512448, 702071808, 793973760, 176151552, 587809792, 830098432, 643343360, 315720704, 237978624, 998233088, 822144000, 1010893824, 387210240, 792787968, 168524800, 254034944, 1032928256, 614226944, 687137792, 752421888, 767267840, 933000192, 1001376768, 352330752, 288142336, 808944640, 180392960, 424901632, 1066173440, 758873088, 135560192, 179569664, 552852480, 533799936 },
   { 512, 570434048, 976886272, 417426944, 1040351744, 975180288, 780541440, 1008730624, 503620096, 713687552, 277586432, 681927168, 527303168, 664453632, 759917056, 672759296, 461552128, 375490048, 360312320, 1054874112, 522873344, 717415936, 731959808, 970366464, 1004984832, 1061075456, 671108608, 310048256, 660785664, 713044480, 1072563712, 406377984, 450923008, 629703168, 681479680, 798513664, 477233664, 14291456, 606903808, 370774528 },
   { 256, 855651072, 757939456, 609285376, 587253504, 254819072, 929251072, 923796224, 654660352, 977993984, 416215808, 892981504, 60228352, 528787712, 861704960, 1014800640, 985737984, 252723456, 910628096, 609239296, 986431232, 478392576, 116402432, 929239296, 377182976, 1020913920, 335559936, 928744704, 951038720, 809542912, 528610048, 875842816, 317733632, 239920896, 208759552, 353686272, 913269504, 230628096, 841539328, 991418624 },
   { 128, 713042560, 429498752, 909831040, 377613696, 378014848, 682667648, 705167744, 311294848, 317555328, 762280576, 931408768, 696419200, 599440256, 916640896, 983095168, 430003584, 285878400, 763432832, 639164800, 1070262656, 467700096, 555228288, 399903104, 828250752, 389997696, 33577856, 519216768, 769826432, 673215104, 804656256, 913441408, 385377152, 690647168, 174626176, 999986816, 522728320, 38710400, 689974912, 882513280 },
   { 64, 1069563840, 1073730496, 1068349120, 792936384, 692328000, 340293440, 755761728, 356964160, 1065173696, 449872960, 139349184, 365117888, 554979648, 154351040, 624947904, 397482944, 39080256, 583043136, 693424192, 846962112, 359720128, 367313600, 207868992, 714062656, 148463424, 822096704, 164047296, 141501504, 611337408, 128800448, 994280256, 352112576, 232736960, 625784640, 461332800, 13900480, 158515648, 93325760, 408238528 },
   { 32, 538976288, 536877600, 383778848, 136568864, 917645344, 942016672, 528875808, 937820768, 134259552, 224396256, 623075744, 250143392, 234881056, 223046176, 58286112, 1020836384, 897680928, 861982240, 663124448, 592616416, 804828768, 529952992, 1045826272, 213420640, 20854432, 830506912, 117984416, 71478816, 976749152, 328784608, 753549920, 901700064, 839019680, 771671968, 817500384, 412286624, 499555872, 760750496, 922465568 },
   { 16, 808464432, 268451088, 256901168, 477245456, 424358960, 204670032, 399049616, 458293552, 1006998352, 718275120, 243192368, 173421520, 889192464, 56398640, 204238864, 779889424, 272646448, 328312080, 193557776, 753395632, 454314128, 415607120, 52656944, 99894160, 198808368, 239130768, 383550384, 41893136, 1062002160, 971796848, 581411728, 360705264, 191044336, 832638512, 602872080, 752820304, 272026928, 226238288, 1001843632 },
   { 8, 673720360, 939532728, 783810616, 920217640, 1050974728, 638099512, 463765848, 403145032, 503921192, 627573000, 86289144, 224614840, 947912712, 782423192, 847456280, 998299064, 409086120, 60454792, 301885432, 653823304, 349865224, 672062648, 1035395640, 191266680, 264170712, 794823752, 366637896, 88781736, 766666408, 818821592, 1031844776, 987805560, 513815176, 58763896, 1059200136, 377549256, 942966152, 491660408, 385588952 },
   { 4, 1010580540, 738202604, 460062740, 1073673228, 492994308, 855920652, 886980780, 67748708, 419601508, 786170252, 510758212, 580428876, 1010827300, 489895380, 155227188, 717446132, 68178284, 185914444, 449682228, 971813788, 1072137996, 878830404, 359923708, 968597820, 563694100, 646980332, 757832668, 234561452, 27856468, 858860980, 792758940, 49308988, 955256396, 180401604, 117132268, 398498236, 205375044, 90642668, 196528004 },
   { 2, 572662306, 436222522, 537001998, 537035294, 747781778, 144717862, 1001218498, 1040490934, 344629966, 996278998, 1025507442, 403571318, 35651630, 726362630, 568466966, 564140562, 579569198, 125378618, 33554434, 55745506, 859963394, 507011074, 317587458, 561918050, 1050583042, 76049922, 903542274, 939549730, 260715010, 315554530, 178320898, 519631842, 763915426, 1029744546, 1018710754, 73456802, 371211122, 425895958, 251363554 },
   { 1, 858993459, 1023421741, 805503019, 268486451, 645602683, 72354867, 81703025, 386224529, 860787559, 1037894061, 309330455, 738656761, 797966373, 576492305, 487706887, 598948629, 85410107, 491171895, 251658243, 1021831089, 12779523, 156561409, 653197315, 580864147, 306827265, 95726851, 1026262273, 469798419, 853910785, 506585459, 298892545, 284985329, 38542067, 298909233, 159697427, 40907601, 154154699, 659543067, 800518305 },
};




/// standard object services ---------------------------------------------------
SobolSequence::SobolSequence()
{
   SobolSequence::setDimension( 0 );
}


SobolSequence::SobolSequence
(
   const dword dimension
)
{
   SobolSequence::setDimension( dimension );
}


SobolSequence::~SobolSequence()
{
}


SobolSequence::SobolSequence
(
   const SobolSequence& other
)
{
   SobolSequence::operator=( other );
}


SobolSequence& SobolSequence::operator=
(
   const SobolSequence& other
)
{
   if( &other != this )
   {
      dimension_m = other.dimension_m;

      index_m              = other.index_m;
      lastDenominatorInv_m = other.lastDenominatorInv_m;
      lastNumerator_m      = other.lastNumerator_m;
      for( int b = SOBOL_BIT_COUNT;  b-- > 0; )
      {
         vDirection_m[b] = other.vDirection_m[b];
      }

      point_m = other.point_m;
   }

   return *this;
}




/// commands -------------------------------------------------------------------
void SobolSequence::setDimension
(
   const dword dimension
)
{
   dimension_m = dimension >= 0 ? (dimension < SOBOL_MAX_DIMENSION ?
      dimension : SOBOL_MAX_DIMENSION - 1) : 0;

   index_m = -1;
   lastDenominatorInv_m = static_cast<float>(1.0 /
      static_cast<double>(0x40000000));
   lastNumerator_m = 0;
   for( int b = SOBOL_BIT_COUNT;  b-- > 0; )
   {
      vDirection_m[b] = V_DIRECTION[b][dimension_m];
   }
   point_m = 0.0f;

   SobolSequence::next();
}


void SobolSequence::setIndex
(
   dword index
)
{
   index = index >= 0 ? index : 0;

   dword advance;
   {
      const dword dif = index - index_m;
      if( dif >= 0 )
      {
         advance = dif;
      }
      else
      {
         setDimension( dimension_m );
         advance = index;
      }
   }

   for( dword i = advance;  i-- > 0; )
   {
      point_m = SobolSequence::nextImplementation();
   }
}


void SobolSequence::next()
{
   point_m = SobolSequence::nextImplementation();
}




/// implementation -------------------------------------------------------------
float SobolSequence::nextImplementation()
{
   ++index_m;

   // find position of least-significant zero in index
   dword leastZeroPos = 1;
   for( udword i = index_m;  (i & 1) != 0;  ++leastZeroPos, i >>= 1 );

   // check for sequence exhaustion
   if( leastZeroPos > SOBOL_BIT_COUNT )
   {
      // go back to start!
      index_m      = 0;
      leastZeroPos = 1;
   }

   float point;
   {
      const dword direction_i     = vDirection_m[leastZeroPos - 1];
      const dword old_numerator_i = lastNumerator_m;
      const dword new_numerator_i = old_numerator_i ^ direction_i;

      lastNumerator_m = new_numerator_i;
      point = new_numerator_i * lastDenominatorInv_m;
   }

   return point;
}
